<!doctype html><html lang=ko-kr><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.110.0"><title>serverless 배포하기 (4) 플러그인 안쓰고 타입스크립트 함수 배포하기 &#183; if1live space</title><meta name=author content="if1live"><meta name=description content="serverless 배포하기 (4) 플러그인 안쓰고 타입스크립트 함수 배포하기"><meta name=keywords content="serverless"><meta name=naver-site-verification content="2ddc1a56777489f4a64a4f6a59822f8b1c1ea502"><meta name=google-site-verification content="VsvNNnJZUV-iLEYKNju16p-HtDqZeqL15H-VVy-HwpA"><meta name=gc:client-id content="785d47c81cbc2fd42b65"><meta name=gc:client-secret content="5e5d558f0b16fae154aa47fc9d94f7c09e540ec7"><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><script type=text/javascript>var host="if1live.github.io";host==window.location.host&&window.location.protocol!="https:"?window.location.protocol="https":console.log("skip https redirect")</script><link rel=stylesheet href=/css/style.6d4b55c42fb0cb4aa353c6bb4ae00f128b4a67641186de5638b6079fc2bf9bb2101c834fbebfc047f30dfce61840db099e5a208cb44bbb4952bfde60f3bea3ee.css integrity="sha512-bUtVxC+wy0qjU8a7SuAPEotKZ2QRht5WOLYHn8K/m7IQHINPvr/AR/MN/OYYQNsJnlogjLRLu0lSv95g876j7g=="><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css integrity="sha512-MV7K8+y+gLIBoVD59lQIYicR65iaqukzvf/nwasF0nqhPay5w/9lJmVM2hMDcnK1OnMGCdVK+iQrJ7lzPJQd1w==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css integrity="sha512-cbQXwDFK7lj2Fqfkuxbo5iD1dSbLlJGXGpfTDqbggqjHJeyzx88I3rfwjS38WJag/ihH7lzuGlGHpDBymLirZQ==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin=anonymous><script async src=//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script>
<script>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-3043297488880636",enable_page_level_ads:!0})</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-SKE54STL16"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-SKE54STL16",{anonymize_ip:!1})}</script></head><body><nav class=theme-navigation><a href=https://if1live.github.io/ title=home><h1>if1live space</h1></a><ul class=nav-link-list><li><a href=https://if1live.github.io/about/ title=about><i class="fa-solid fa-info"></i>
<span hidden>about</span></a></li><li><a href=https://if1live.github.io/archives/ title=archives><i class="fa-solid fa-box-archive"></i>
<span hidden>archives</span></a></li><li><a href=https://if1live.github.io/tags/ title=tags><i class="fa-solid fa-tags"></i>
<span hidden>tags</span></a></li><li><a href=https://if1live.github.io/search/ title=search><i class="fa-solid fa-magnifying-glass"></i>
<span hidden>search</span></a></li></ul></nav><main class=container><article class="basic-content article-content"><header><hgroup class=entry-title><a href=/posts/deploying-serverless-4-pnpm-with-script/ rel=bookmark title="Permalink to serverless 배포하기 (4) 플러그인 안쓰고 타입스크립트 함수 배포하기"><h1>serverless 배포하기 (4) 플러그인 안쓰고 타입스크립트 함수 배포하기</h1></a></hgroup></header><footer class=post-info><abbr class=published title=2022-08-20T20:00:00+09:00>2022/08/20</abbr><address class="vcard author">By <a href=//twitter.com/if1live>@if1live</a></address><ul class="list-of-tags tags-in-article"><li><a href=/tags/serverless>#serverless</a></li></ul></footer><section class=entry-content><p><a href=/posts/deploying-serverless-3-flaw-of-serverless-webpack>이전글</a>에서는 serverless-webpack 를 사용했을때 발생할 수 있는 문제를 다뤘다.
이번에는 serverless-webpack같은 플러그인을 쓰지 않고 serverless framework만으로 타입스크립트 함수를 배포한다.
손으로 serverless를 배포해보면 AWS Lambda 핸들러가 어떻게 돌아갈지 이해하고 어떤 부분을 더 개선할수 있을지 보인다.</p><h2 id=빌드>빌드</h2><p>타입스크립트로 간단한 핸들러를 작성하고 webpack을 사용해서 번들링한다.
요새는 webpack 잘 안쓴다던데 예제 코드를 작성한게 2021년이라서 webpack을 유지했다.
관심있는 주제는 배포라서 타입스크립트, webpack 설정파일은 따로 다루지 않았다. (이전글 참고)</p><p><code>webpack-node-externals</code>을 사용해서 번들링된 js에 패키지가 포함되는걸 피했다.
웹팩 빌드하면 <code>.webpack/src/handler.js</code>, <code>.webpack/src/handler.js.map</code>이 생긴다.
(<code>.webpack</code>은 serverless-webpack이 쓰는 디렉토리 이름)</p><h2 id=pnpm>pnpm</h2><p>패키지 매니저로 <a href=https://pnpm.io/>pnpm</a>을 사용했다.
패키지 매니저는 관심있는 주제가 아니라서 npm, yarn을 써도 된다.
pnpm을 쓰면 <code>node_modules</code>을 직접 손대는게 쉬워서 이번에는 pnpm을 썼다.</p><h2 id=패키징>패키징</h2><p>람다로 배포하려면 zip 파일 1개로 실행에 필요한 모든걸 우겨넣어야한다.
serverless-webpack과 같은 플러그인을 쓰면 직접 하지 않아도 되는 작업이다.
이번에는 플러그인을 쓰지 않기로 했으니 스크립트를 작성했다.</p><pre><code class=language-bash>#!/bin/bash

set -exuo pipefail

DIR_TMP=artifact

function prepare {
	mkdir -p $DIR_TMP
	cp package.json pnpm-*.yaml $DIR_TMP
	cp -r .webpack/src $DIR_TMP
}

function install_package {
	pushd $DIR_TMP

	pnpm install --prod --frozen-lockfile --offline

	# 불필요한 패키지, 파일 삭제
	rm -rf node_modules/.pnpm/@types+*
	rm -rf node_modules/.pnpm/figlet@*
	rm -rf node_modules/.pnpm/aws-sdk@*

	# https://unix.stackexchange.com/a/622875
	find node_modules/.pnpm -depth -name &quot;test&quot; -type d -execdir rm -rf {} +
	find node_modules/.pnpm -depth -name &quot;tests&quot; -type d -execdir rm -rf {} +
	find node_modules/.pnpm -depth -name &quot;__tests__&quot; -type d -execdir rm -rf {} +

	find node_modules/.pnpm -name &quot;*.ts&quot; -type f -delete
	find node_modules/.pnpm -name &quot;*.map&quot; -type f -delete
	find node_modules/.pnpm -name &quot;*test*&quot; -type f -delete

	popd
}

function archive_artifact {
	pushd $DIR_TMP
	zip -r --symlinks -q ../artifact.zip node_modules src
	popd
}

prepare
install_package
archive_artifact
</code></pre><ol><li>prepare<ul><li><code>artifact</code> 디렉토리 생성</li><li>webpack으로 번들링한 결과물을 <code>artifact</code>로 복사</li><li>pnpm으로 패키지 설치할때 필요한 파일을 <code>artifact</code>로 복사</li></ul></li><li>install_package<ul><li><code>artifact</code> 디렉토리 안에서 pnpm으로 의존성 패키지 설치</li><li>없어도 되는 파일을 <code>node_modules</code>에서 삭제해서 크기 줄임</li></ul></li><li>archive_artifact<ul><li><code>artifact</code> 디렉토리를 <code>artifact.zip</code>으로 압축</li><li>심볼릭 링크까지 잘 처리하기 (pnpm이 심볼릭 링크를 쓴다)</li></ul></li></ol><h2 id=serverlessyml>serverless.yml</h2><pre><code class=language-yaml>service: hello-pnpm-with-script

frameworkVersion: '2'

package:
  artifact: artifact.zip

provider:
  name: aws
  runtime: nodejs14.x
  lambdaHashingVersion: 20201221

  memorySize: 128
  logRetentionInDays: 1
  versionFunctions: false

  region: ap-northeast-1

functions:
  hello:
    handler: src/handler.hello
    events:
      - httpApi: '*'
</code></pre><p>패키징을 수동으로 처리해서 serverless framework는 무엇을 배포해야되는지 모른다.
package 항목으로 artifact 파일을 지정해준다.</p><pre><code class=language-yml>package:
  artifact: artifact.zip
</code></pre><p>람다 함수의 handler는 실행될 람다 핸들러를 뜻한다.
타입스크립트로 작성된 <code>src/handler.ts</code>의 함수 <code>hello</code>는 <code>artifact.zip</code>에 없다.
<code>artifact.zip</code>에 있는 webpack으로 번들링된 자바스크립트 핸들러의 함수를 지정해야된다.
<code>src/handler.js</code>의 함수 <code>hello</code>를 연결해야되니까 <code>src/handler.hello</code>를 넣는다.</p><h2 id=배포>배포</h2><pre><code class=language-bash># typescript --(webpack)--&gt; javascript
pnpm webpack

# javascript, node_modules/, ... --(compress)--&gt; artifact.zip
./build-artifact.sh

# deploy
pnpm sls deploy
</code></pre><h2 id=next>next?</h2><p>수동으로 artifact를 생성해서 배포해보니까 어떤 부분을 더 개선할수 있을지 보이더라.
다음 글에는 2022년의 방식으로 타입스크립트 함수를 람다에 배포해본다.</p><p>이번 글의 예제 코드는 2021년 8월에 작성되었다.
스크립트를 사용해서 빌드 아티팩트를 생성해서 serverless 배포하는건 과도기적 형태같아서 글을 마무리하지 1년동안 방치했다.
1년쯤 지나니까 타입스크립트 함수를 람다로 배포하는 더 우아한 방법을 알겠더라. 그래서 오랜만에 글을 써 봤다.</p></section><ul class=articles-timeline><li class=previous-article><a href=https://if1live.github.io/posts/typescript-pitfall-of-promise-and-error/ title="Next: 타입스크립트 + Promise + async/await + Error = ???">타입스크립트 + Promise + async/await + Error = ???<br><small>컴파일은 되지만 런타임 동작을 보장하는건 아니라구요</small></a></li><li class=next-article><a href=https://if1live.github.io/posts/deploying-serverless-5-zero-configuration/ title="Previous: serverless 배포하기 (5) 최소한의 설정파일로 타입스크립트 함수 배포하기">serverless 배포하기 (5) 최소한의 설정파일로 타입스크립트 함수 배포하기</a></li></ul><section class=entry-content><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//libsora.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></article></main><footer class=theme-footer><ul class=nav-link-list><li><a href=//twitter.com/if1live title=Twitter><i class="fa-brands fa-twitter"></i>
<span hidden>Twitter</span></a></li><li><a href=//github.com/if1live title=GitHub><i class="fa-brands fa-github"></i>
<span hidden>GitHub</span></a></li><li><a href=//bitbucket.org/if1live title=BitBucket><i class="fa-brands fa-bitbucket"></i>
<span hidden>BitBucket</span></a></li><li><a href=https://if1live.github.io/index.xml><i class="fa-solid fa-rss"></i>
<span hidden>RSS</span></a></li></ul><p><a href=//gohugo.io/ title=Hugo>Hugo</a> |
<a href=//twitter.com/if1live/ title=@if1live>@if1live</a></p></footer><script src=/js/main.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js integrity="sha512-BttltKXFyWnGZQcRWj6osIg7lbizJchuAMotOkdLxHxwt/Hyo+cl47bZU0QADg+Qt5DJwni3SbYGXeGMB5cBcw==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-clike.min.js integrity="sha512-/Rynaa6ehLZJO9fdk+EUsgiOdJqFSFUB4Qgy+gP4vU4U1DrmPJWypfXe1CgyaV7rRdZjGxdpLe9djxhx1ZHvqQ==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-c.min.js integrity="sha512-8VrjxGFLIkS0mgEmO3p46A5OkqATHhrNVwyv2V7yUeZrk1jmSDuI3SOEpC9XHEHUWEOsfzzcJeBlUkee9lKGrw==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-cpp.min.js integrity="sha512-namzGTZvHaug0jeipHRN2pMepMiJj+EbrloktVFlMYGnA0EwZhbdLeENjBYLCgoghVbZGinIz/FFYHmB0o3wLw==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js integrity="sha512-uOw7XYETzS/DPmmirpP5UCMihSDNMeyTS965J0/456OSPfxn9xEtHHjj5Q/5WefVdqyMfN/afmQnNpZd/tpkcA==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js integrity="sha512-AKaNmg8COK0zEbjTdMHJAPJ0z6VeNqvRvH4/d5M4sHJbQQUToMBtodq4HaV4fa+WV2UTfoperElm66c9/8cKmQ==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js integrity="sha512-jwrwRWZWW9J6bjmBOJxPcbRvEBSQeY4Ad0NEXSfP0vwYi/Yu9x5VhDBl3wz6Pnxs8Rx/t1P8r9/OHCRciHcT7Q==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js integrity="sha512-xKcnbsdT0KMoA4yrozkqZM1XJVTrPsjdQwvigxlAlxEDu8YDvC/jl+LfVqn0fY3Vs6m2y4a89JCHEIA/Z9zpmQ==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-csharp.min.js integrity="sha512-pmt3kb6dRndjFXFFwCa3rSzuUQ0GjeCfC5QULWde+8ZBIsUzuP1heOIOSAMfAyXHSufrrTp8h7UHw85K4IJ2/g==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js integrity="sha512-whYhDwtTmlC/NpZlCr6PSsAaLOrfjVg/iXAnC4H/dtiHawpShhT2SlIMbpIhT/IL/NrpdMm+Hq2C13+VKpHTYw==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-ruby.min.js integrity="sha512-/Dti0iV9cxgJe8r0U/89YJIv9ZBQu1ExEWffVyBj4juMQ4GNglQ3TQ0Up4gcbiHvg0g87arcUFbKBtw2PxH1Dw==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-go.min.js integrity="sha512-w200Nz1i9KgDNi+IpPMgpZBVRIvfVK/V5vskyHjkz7XJkVnRJcb1uNmpiHhDv0/Ln+GG2VqScKKz/1izBfg64Q==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-less.min.js integrity="sha512-lL5HvfIycntK04Iiai/VTsyuj7mvDkhz9k+cA8fqXr932s4jLJ1YwplIs6Dhpw0pzVwAe1jGe8sGwbyuHG44QQ==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-scss.min.js integrity="sha512-aczOaJ+mB9uGT6dMJbDaUsS2PWG+XII+1ypFQ0L22Z132V6kMM6m70pQssXsPAFmLI5xkgx/hknBuUuJIJKZfA==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js integrity="sha512-uMdVuOpm+9lNPCT7mV/YaMb9YQ/R4+eeON7aEMj6Ig/f4BoU+Q5k6iaZkDsX7LH9cjTHZt0CuKxbzd0/fndrWA==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js integrity="sha512-QXFMVAusM85vUYDaNgcYeU3rzSlc+bTV4JvkfJhjxSHlQEo+ig53BtnGkvFTiNJh8D+wv6uWAQ2vJaVmxe8d3w==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js integrity="sha512-6O/PZimM3TD1NN3yrazePA4AbZrPcwt1QCGJrVY7WoHDJROZFc9TlBvIKMe+QfqgcslW4lQeBzNJEJvIMC8WhA==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-batch.min.js integrity="sha512-tPgIjUKiv2HcUAIWXA3v6G4cNuWXkoMsF+ibxfHLnp+/s1C3Bw5/qp78+JjhrfoyWIiHXHx0LtH4M/LAwyQqWg==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lisp.min.js integrity="sha512-W461RnQzrhSCQQMfEGFKOHbK2DuJTVxrXs2PzctPaxV3A+qPB/TcnMgucSsBNkyccNK8VoENBsAnbf/SuBE71g==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/mermaid/9.3.0/mermaid.min.js integrity="sha512-ku2nmBrzAXY5YwohzTqLYH1/lvyMrpTVxgQKrvTabd/b/uesqltLORdmpVapYv6QhZVCLUX6wkvFaKOAY4xpUA==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script>mermaid.initialize({startOnLoad:!0}),function(){const e=document.querySelectorAll("code.language-mermaid");for(let t=0;t<e.length;t++){const s=`mermaid-${t}`,n=e[t],o=n.innerText,i=e=>{const t=document.createElement("div");t.innerHTML=e,n.parentElement.replaceWith(t)};mermaid.render(s,o,i)}}()</script><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin=anonymous></script>
<script>renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]});for(var inlineMathArray=document.querySelectorAll("script[type='math/tex']"),inlineMath,tex,replaced,displayMathArray,displayMath,i=0;i<inlineMathArray.length;i++)inlineMath=inlineMathArray[i],tex=inlineMath.innerText||inlineMath.textContent,replaced=document.createElement("span"),replaced.innerHTML=katex.renderToString(tex,{displayMode:!1}),inlineMath.parentNode.replaceChild(replaced,inlineMath);displayMathArray=document.querySelectorAll("script[type='math/tex; mode=display']");for(i=0;i<displayMathArray.length;i++)displayMath=displayMathArray[i],tex=displayMath.innerHTML,replaced=document.createElement("span"),replaced.innerHTML=katex.renderToString(tex.replace(/%.*/g,""),{displayMode:!0}),displayMath.parentNode.replaceChild(replaced,displayMath)</script></body></html>