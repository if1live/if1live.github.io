<!doctype html><html class=no-js lang=ko><head><meta charset=utf-8><meta name=generator content="Hugo 0.110.0"><title>Jest 탈출기 - Jest는 느리다 &#183; /usr/lib/libsora.so</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=naver-site-verification content="2ddc1a56777489f4a64a4f6a59822f8b1c1ea502"><meta name=google-site-verification content="VsvNNnJZUV-iLEYKNju16p-HtDqZeqL15H-VVy-HwpA"><meta name=gc:client-id content="785d47c81cbc2fd42b65"><meta name=gc:client-secret content="5e5d558f0b16fae154aa47fc9d94f7c09e540ec7"><meta name=author content="if1live"><meta name=description content="Jest 탈출기 - Jest는 느리다"><meta name=keywords content="testing,jest,mocha"><meta name=twitter:card content="summary"><meta name=og:url content="https://if1live.github.io/posts/escape-from-jest-jest-is-slow/"><meta name=twitter:site content="@if1live"><meta name=twitter:title content="Jest 탈출기 - Jest는 느리다"><meta name=twitter:description content="개요 요새 작업하는 프로젝트에서 jest를 사용해서 유닛테스트를 돌린다. 프로젝트가 진행될수록 테스트가 점점 느려지더니 이제 유닛 테스트 한번 돌리는데 1분이 걸린다. 라이젠 붙은 좋은 컴퓨터에서 CI 돌리는데 여기에서도 30초나 걸린다.
근데 같은 테스트 코드를 mocha로 돌리면 몇초 안걸리더라? jest는 mocha와 달리 병렬적으로 테스트가 돌아가니"><meta name=twitter:image:src content="https://www.gravatar.com/avatar/fb9672e7e0d256f39369595381d1ea07"><link rel=stylesheet href=https://if1live.github.io/css/style-gen.css?2><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link href=https://if1live.github.io/index.xml rel=alternate type=application/rss+xml title=/usr/lib/libsora.so><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/themes/prism.min.css integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/plugins/line-numbers/prism-line-numbers.min.css integrity="sha512-cbQXwDFK7lj2Fqfkuxbo5iD1dSbLlJGXGpfTDqbggqjHJeyzx88I3rfwjS38WJag/ihH7lzuGlGHpDBymLirZQ==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin=anonymous><script type=text/javascript>var host="if1live.github.io";host==window.location.host&&window.location.protocol!="https:"?window.location.protocol="https":console.log("skip https redirect")</script><script async src=//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script>
<script>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-3043297488880636",enable_page_level_ads:!0})</script></head><body><header class=header><h1 class=font-monospace><a href=https://if1live.github.io/>/usr/lib/libsora.so</a></h1><nav><h2 hidden>Navigation</h2><ul class=nav-link-list><li><a href=https://if1live.github.io/tags/ title=tags><i class="fa fa-tags"><span hidden>Tags</span></i></a></li><li><a href=https://if1live.github.io/search/ title=search><i class="fa fa-search"><span hidden>Search</span></i></a></li></ul></nav></header><div class=container><article class="basic-content article-content"><header><hgroup class=entry-title><a href=/posts/escape-from-jest-jest-is-slow/ rel=bookmark title="Permalink to Jest 탈출기 - Jest는 느리다"><h1>Jest 탈출기 - Jest는 느리다</h1><h2>jest는 왜 mocha보다 느린가?</h2></a></hgroup></header><footer class=post-info><abbr class=published title=2019-07-01T01:00:00+09:00>2019/07/01</abbr><address class="vcard author">By <a href=//twitter.com/if1live>@if1live</a></address><ul class="list-of-tags tags-in-article"><li><a href=/tags/testing>#testing</a></li><li><a href=/tags/jest>#jest</a></li><li><a href=/tags/mocha>#mocha</a></li></ul></footer><section class=entry-content><h2 id=개요>개요</h2><p>요새 작업하는 프로젝트에서 jest를 사용해서 유닛테스트를 돌린다.
프로젝트가 진행될수록 테스트가 점점 느려지더니 이제 유닛 테스트 한번 돌리는데 1분이 걸린다.
라이젠 붙은 좋은 컴퓨터에서 CI 돌리는데 여기에서도 30초나 걸린다.</p><p>근데 같은 테스트 코드를 mocha로 돌리면 몇초 안걸리더라?
jest는 mocha와 달리 병렬적으로 테스트가 돌아가니 훨씬 빨라야 하지 않나?
근데 몇배가 느리다고?</p><p>왜 jest가 mocha보다 느리게 테스트가 굴러가는지 뜯어봤다.</p><h2 id=속도-비교>속도 비교</h2><pre><code class=language-js>const a1 = Date.now();
var express = require('express');
const a2 = Date.now();
var express = require('express');
const a3 = Date.now();

const pid = process.pid;
console.log(`first load: ${(a2 - a1) / 1000} pid=${pid}`);
console.log(`second load: ${(a3 - a2) / 1000} pid=${pid}`);

const expect = require('expect');

it(__filename, () =&gt; expect(1).toBe(1));
</code></pre><p>위의 테스트 코드를 복사해서 3개의 테스트 파일로 만들었다.
3개의 테스트 스위트를 통해 다음의 요소를 확인하고 싶었다.</p><ol><li>express를 처음으로 import하는데 걸리는 시간</li><li>express를 두번째 import하는데 걸리는 시간</li><li>테스트 프로세스의 pid</li></ol><h2 id=실행-결과>실행 결과</h2><h3 id=mocha>mocha</h3><pre><code class=language-txt>first load: 0.124 pid=18380
second load: 0 pid=18380
first load: 0 pid=18380
second load: 0 pid=18380
first load: 0 pid=18380
second load: 0 pid=18380
</code></pre><ul><li>모든 테스트의 pid는 동일하다.</li><li>첫번째 import에서만 시간이 소모된다.</li><li>일단 import를 했으면 그 이후의 import는 캐싱된다.</li></ul><h3 id=jest>jest</h3><p><code>--runInBand</code> 옵션을 넣고 돌리면 jest는 하나의 worker로 돌아간다.
아래와 비슷한 결과를 얻을수 있다.</p><pre><code class=language-txt>PASS test/a.test.js
  ● Console

    console.log test/a.test.js:8
      first load: 0.216 pid=15604
    console.log test/a.test.js:9
      second load: 0 pid=15604

PASS test/c.test.js
  ● Console

    console.log test/c.test.js:8
      first load: 0.021 pid=15604
    console.log test/c.test.js:9
      second load: 0 pid=15604

PASS test/b.test.js
  ● Console

    console.log test/b.test.js:8
      first load: 0.021 pid=15604
    console.log test/b.test.js:9
      second load: 0 pid=15604
</code></pre><ul><li>모든 테스트의 pid는 동일하다. <code>--runInBand</code>가 없으면 pid는 여러개가 된다.</li><li>각각의 테스트 스위트에서 처음으로 import할때 시간이 소모된다.</li><li>두번째 import는 시간이 걸리지 않는다. 캐싱된 물건을 쓰나보다.</li></ul><h3 id=mocha-vs-jest>mocha vs jest</h3><p>mocha는 한번 import하면 그 이후에는 캐싱된 결과물을 사용한다.
일반적인 node 프로그램과 동일한 방식이다.</p><p>jest는 각각의 테스트 스위트가 고립된 상태로 돌아간다.
같은 프로세스 안에서 돌아가더라도 테스트 스위트가 다르면 import를 다시 한다.</p><h2 id=왜-둘은-다른가>왜 둘은 다른가?</h2><p>jest 문서를 제대로 읽어보면 설명을 찾을 수 있을지 모른다.
하지만 나는 영어만 읽으면 정신이 피곤해지니 반대로 접근했다.
문서에서 vm으로 검색해서 관련된 <a href=https://jestjs.io/docs/en/configuration#extraglobals-array-string>항목</a>을 발견할 수 있었다.</p><blockquote><p>Test files run inside a vm, which slows calls to global context properties (e.g. Math).
With this option you can specify extra properties to be defined inside the vm for faster lookups.</p></blockquote><p><a href=https://nodejs.org/api/vm.html>VM (Executing JavaScript)</a>을 쓴다니!
각각의 테스트 스위트를 독립적으로 돌리기 위해서 vm을 사용한 jest의 접근법이 이해가 된다.
각각의 vm이 독립적으로 돌아갈테니 import를 매번 하는 것도 알겠더라.</p><h2 id=jest-탈출기>Jest 탈출기</h2><p>내가 요새 작업하는 물건은 express 기반 서버이다.
<a href=https://github.com/visionmedia/supertest>supertest</a>를 이용해서 대부분의 API에 통합 테스트(integration testing)를 적용해놨다.
아래와 같은 테스트가 각각의 API endpoint 별로 작성되어 있다.</p><pre><code class=language-ts>import { makeApp } from '@server/app';

const app = makeApp();

describe('GET /user', () =&gt; {
  test('ok', done =&gt; {
    request(app)
      .get('/user')
      .expect(200, done);
  });
});
</code></pre><p>순서대로 생각하면 jest가 느린 이유가 잘 보인다.</p><ol><li>작업중인 프로젝트는 express 기반 서버</li><li><code>makeApp()</code>은 사실상 <code>main()</code> 역할</li><li><code>makeApp()</code>을 import하는 과정을 따라가면 프로젝트 전체를 import하게 된다.</li><li>각각의 테스트 스위트마다 프로젝트 전체를 import한다.</li><li>프로젝트가 커지면 <code>makeApp()</code> import하는 시간이 점점 더 느려진다.</li><li>테스트 스위트가 많아질수록 테스트 돌아가는 시간이 길어진다.</li></ol><p>반면 mocha의 경우는 각각의 테스트는 하나의 프로그램 안에서 돌아간다.
import를 매번하지 않으니까 훨씬 빠르다.
그래서 나는 jest를 버리고 mocha로 갈아타기로 했다.
테스트간의 독립성보다 빠른 이터레이션이 나한테는 훨씬 중요하다.</p></section><ul class=articles-timeline><li class=previous-article><a href=https://if1live.github.io/posts/make-typesafe-express-app/ title="Next: 타입 안전한 express 앱 구현하기">타입 안전한 express 앱 구현하기<br><small>타입스크립트를 쓰면 타입스크립트 사용법을 따르라</small></a></li><li class=next-article><a href=https://if1live.github.io/posts/escape-from-jest-use-mocha/ title="Previous: Jest 탈출기 - Mocha를 쓰자">Jest 탈출기 - Mocha를 쓰자<br><small>Jest/Mocha 동시에 지원하기</small></a></li></ul><section class=entry-content><section class=disqus-section><h1 hidden>Comment</h1><div id=disqus_thread></div><script type=text/javascript>var host="if1live.github.io",disqus_shortname,disqus_identifier;host==window.location.host?(disqus_shortname="libsora",disqus_identifier="http://if1live.github.io/posts/escape-from-jest-jest-is-slow/",function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()):console.log("skip disqus")</script><noscript>Please enable JavaScript to view the <a href=//disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=//disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></section></article></div><footer class=footer><ul class=nav-link-list><li><a href=//twitter.com/if1live title=Twitter><i class="fa fa-twitter"></i></a></li><li><a href=//github.com/if1live title=GitHub><i class="fa fa-github"></i></a></li><li><a href=//bitbucket.org/if1live title=BitBucket><i class="fa fa-bitbucket"></i></a></li><li><a href=https://if1live.github.io/index.xml><i class="fa fa-rss"></i></a></li></ul><p><a href=//gohugo.io/ title=Hugo>Hugo</a> |
<a href=//twitter.com/if1live/ title=@if1live>@if1live</a></p></footer><script src=/js/common.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/prism.min.js integrity="sha512-pSVqGtpGygQlhN8ZTHXx1kqkjQr30eM+S6OoSzhHGTjh6DKdfy7WZlo1DNO9bhtM0Imf6xNLznZ7iVC2YUMwJQ==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/plugins/line-numbers/prism-line-numbers.min.js integrity="sha512-dubtf8xMHSQlExGRQ5R7toxHLgSDZ0K7AunqPWHXmJQ8XyVIG19S1T95gBxlAeGOK02P4Da2RTnQz0Za0H0ebQ==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/components/prism-clike.min.js integrity="sha512-/Rynaa6ehLZJO9fdk+EUsgiOdJqFSFUB4Qgy+gP4vU4U1DrmPJWypfXe1CgyaV7rRdZjGxdpLe9djxhx1ZHvqQ==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/components/prism-c.min.js integrity="sha512-8VrjxGFLIkS0mgEmO3p46A5OkqATHhrNVwyv2V7yUeZrk1jmSDuI3SOEpC9XHEHUWEOsfzzcJeBlUkee9lKGrw==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/components/prism-cpp.min.js integrity="sha512-UYkJiZs5kymKJMPLLVBpexawnvmoh9jMW9H10z96GF8ldp6SDS8FI4BhBMa2rbHoCyc8mc8gSAMgqIj6NXtmYg==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/components/prism-typescript.min.js integrity="sha512-uOw7XYETzS/DPmmirpP5UCMihSDNMeyTS965J0/456OSPfxn9xEtHHjj5Q/5WefVdqyMfN/afmQnNpZd/tpkcA==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/components/prism-python.min.js integrity="sha512-AKaNmg8COK0zEbjTdMHJAPJ0z6VeNqvRvH4/d5M4sHJbQQUToMBtodq4HaV4fa+WV2UTfoperElm66c9/8cKmQ==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/components/prism-javascript.min.js integrity="sha512-VO0P6Z9Sapwza0d0oiGt76iOVbaJYeLEDQPVJV7N8T+TOPzeAhz4wGtqFa8Pv/mYpgD1Hm3jU4NslIDVlijyDg==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/components/prism-java.min.js integrity="sha512-Ofz52khK2GpJagclW2MrjJ8eum/j47Tllh7HiIyB+IpDNRhr98LNspUJZ8RlotjArl8tQbf52Y2e1i/W/TxDJA==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/components/prism-csharp.min.js integrity="sha512-NohR0FaHlz90CtXG/syKPx9DUzzupUltzyiY0RrNsOryPY3NIusNThXSiusO+tIrTfgqRBvANPqBej/O+FKf2w==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/components/prism-bash.min.js integrity="sha512-ZqfG//sXQwAA7DOArFJyMmZQ3knKe+0ft3tPQZPvDPJR04IatmhVO5pTazVV+fLVDYSy28PhoBeUj5wxGRiGAA==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/components/prism-ruby.min.js integrity="sha512-/Dti0iV9cxgJe8r0U/89YJIv9ZBQu1ExEWffVyBj4juMQ4GNglQ3TQ0Up4gcbiHvg0g87arcUFbKBtw2PxH1Dw==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/components/prism-go.min.js integrity="sha512-w200Nz1i9KgDNi+IpPMgpZBVRIvfVK/V5vskyHjkz7XJkVnRJcb1uNmpiHhDv0/Ln+GG2VqScKKz/1izBfg64Q==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/components/prism-less.min.js integrity="sha512-lL5HvfIycntK04Iiai/VTsyuj7mvDkhz9k+cA8fqXr932s4jLJ1YwplIs6Dhpw0pzVwAe1jGe8sGwbyuHG44QQ==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/components/prism-scss.min.js integrity="sha512-aczOaJ+mB9uGT6dMJbDaUsS2PWG+XII+1ypFQ0L22Z132V6kMM6m70pQssXsPAFmLI5xkgx/hknBuUuJIJKZfA==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/components/prism-css.min.js integrity="sha512-Jv/EO8zjSyqIDa2S0YjCGFY+mEROxud6g7AhfA0KcggjdzhPBhoRyetxV7G7/dnfBdZBzcOvpRn1K+J6sn3jyw==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/components/prism-json.min.js integrity="sha512-QXFMVAusM85vUYDaNgcYeU3rzSlc+bTV4JvkfJhjxSHlQEo+ig53BtnGkvFTiNJh8D+wv6uWAQ2vJaVmxe8d3w==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/components/prism-yaml.min.js integrity="sha512-/oDzFMYD7kk0uSmERPYzNTGBREQ2mZGYoorj8utUwL4ZWlOuvEWZx8ZJlhsC8XJEnUTKkXXnRh+Wp6ywIx1Qfg==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/components/prism-batch.min.js integrity="sha512-bBPg+8MazXGrcD6KljRj3G/1ys1VnNro8UqYTVJ2aqlf/8w4xAsDtUXiNqaKqi2YG7Jiu+0MzXJ/WYTKcfgOzQ==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/components/prism-lisp.min.js integrity="sha512-OdRCYv/rRTwewSGidXYslYI1PU5qjCQbwkF8MJomC0p/AvwHxfOxJOdQbittuP0Vu/sY8AXWM6wxTJmff5LFmw==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.8.3/mermaid.min.js integrity="sha512-+TNmhaRJf3jyYHTpzEq/5I6b+aGyhzWb21mGdHAjxSGSYwxN9Grug3Y3B9qVxWfKKY8MscE/6mr9walWvFLFvQ==" crossorigin=anonymous></script>
<script>mermaid.initialize({startOnLoad:!0}),function(){const e=document.querySelectorAll("code.language-mermaid");for(let t=0;t<e.length;t++){const s=`mermaid-${t}`,n=e[t],o=n.innerText,i=e=>{const t=document.createElement("div");t.innerHTML=e,n.parentElement.replaceWith(t)};mermaid.render(s,o,i)}}()</script><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin=anonymous></script>
<script>renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]});for(var inlineMathArray=document.querySelectorAll("script[type='math/tex']"),inlineMath,tex,replaced,displayMathArray,displayMath,i=0;i<inlineMathArray.length;i++)inlineMath=inlineMathArray[i],tex=inlineMath.innerText||inlineMath.textContent,replaced=document.createElement("span"),replaced.innerHTML=katex.renderToString(tex,{displayMode:!1}),inlineMath.parentNode.replaceChild(replaced,inlineMath);displayMathArray=document.querySelectorAll("script[type='math/tex; mode=display']");for(i=0;i<displayMathArray.length;i++)displayMath=displayMathArray[i],tex=displayMath.innerHTML,replaced=document.createElement("span"),replaced.innerHTML=katex.renderToString(tex.replace(/%.*/g,""),{displayMode:!0}),displayMath.parentNode.replaceChild(replaced,displayMath)</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-37862172-2"></script>
<script>var host="if1live.github.io";if(host==window.location.host){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-37862172-2")}else console.log("skip google analytics")</script></body></html>