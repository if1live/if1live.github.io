{% extends "base.html" %}

{% block title %}Tags Â· {{ super() }}{% endblock %}

{% block content %}
<section class="tags-content basic-content">
<h1>Tags for {{ SITENAME }}</h1>

<form class="pure-form form-tag-search">
  <input type="search" placeholder="Find a tag" class="filterinput"/>
</form>

<ul class="list-of-tags">
{% for tag, articles in tags|sort %}
  <li>
  <a href="#{{ tag|replace(' ', '-')|e }}-ref" class="tag-link">{{ tag }}</a>
  </li>
{% endfor %}
</ul>

<div class="tag-article-list-section-wrapper">
{% for tag, articles in tags|sort %}
<details id="{{ tag|replace(' ', '-')|e }}-ref" class="tag-article-list-section">
<summary class="tag-title">{{ tag }}</summary>
<ul>
{% for article in articles %}
<li>
  <a href="{{ SITEURL }}/{{ article.url }}">
  {{ article.title }}
  {% if article.subtitle %} - {{ article.subtitle }}{% endif %}</a>
</li>
{% endfor %}
</ul>
</details>
{% endfor %}
</div>

</section>
{% endblock %}

{% block script %}
<script>
require(['jquery'], function($) {
  function urlToRef(url) {
    return url.substr(url.indexOf('#') + 1);
  }

  $('.tag-link').click(function(evt) {
    var target = urlToRef(this.href);
    var node = document.getElementById(target);
    if(node.style.display !== 'block') {
      node.style.display = 'block';
      node.setAttribute('open', 'open');

      $(this).addClass('active');

    } else {
      node.style.display = 'none';
      node.removeAttribute('open');

      $(this).removeClass('active');
    }
    return false;
  });

  (function() {
    var target = urlToRef(window.location.hash);
    if(target) {
      var node = document.getElementById(target);
      node.style.display = 'block';
      node.open = 'open';
    }
  })();

  (function ($) {
    // custom css expression for a case-insensitive contains()
    jQuery.expr[':'].Contains = function(a,i,m){
      return (a.textContent || a.innerText || "").toUpperCase().indexOf(m[3].toUpperCase())>=0;
    };

    function listFilter() {
      $('.filterinput')
      .change( function () {
        $('.tag-link').removeClass('active');

        var filter = $(this).val();
        if(filter) {
          // this finds all links in a list that contain the input,
          // and hide the ones not containing the input while showing the ones that do
          var hiddenList = $('.list-of-tags').find("a:not(:Contains(" + filter + "))");
          var visibleList = $('.list-of-tags').find("a:Contains(" + filter + ")");

          hiddenList.parent().hide();
          visibleList.parent().show();

          $.each(hiddenList, function(idx, el) {
            el.classList.remove('active');

            var target = urlToRef(el.href);
            var node = document.getElementById(target);
            node.style.display = 'none';
            node.removeAttribute('open');
          });
          $.each(visibleList, function(idx, el) {
            el.classList.add('active');

            var target = urlToRef(el.href);
            var node = document.getElementById(target);
            node.style.display = 'block';
            node.setAttribute('open', 'open');
          });
        } else {
          $('.list-of-tags').find("li").show();
          $('.tag-article-list-section').hide();
        }
        return false;
      })
      .keyup( function () {
        // fire the above change event after every letter
        $(this).change();
      });
    }

    //ondomready
    $(function () {
      listFilter($());
    });
  }(jQuery));
});
</script>
{% endblock %}
