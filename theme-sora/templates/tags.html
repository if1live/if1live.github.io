{% extends "base.html" %}

{% block title %}Tags Â· {{ super() }}{% endblock %}

{% block content %}
<section class="tags-content basic-content">
<h1>Tags for {{ SITENAME }}</h1>

<form class="pure-form form-tag-search">
  <input type="search" placeholder="Find a tag" class="filterinput"/>
</form>

<ul class="list-of-tags">
{% for tag, articles in tags|sort %}
  <li>
  <a href="#{{ tag|replace(' ', '-')|e }}-ref" class="tag-link">
  #{{ tag }}
  </a>
  </li>
{% endfor %}
</ul>

<div class="tag-article-list-section-wrapper">
{% for tag, articles in tags|sort %}
<section id="{{ tag|replace(' ', '-')|e }}-ref" class="tag-article-list-section">
<h2 class="tag-title">{{ tag }}</h2>
<ul>
{% for article in articles %}
<li>
  <a href="{{ SITEURL }}/{{ article.url }}">
  {{ article.title }}
  {% if article.subtitle %} - {{ article.subtitle }}{% endif %}</a>
</li>
{% endfor %}
</ul>
</section>
{% endfor %}
</div>

</section>
{% endblock %}

{% block script %}
<script>
require(['jquery'], function($) {
  function urlToRef(url) {
    return url.substr(url.indexOf('#') + 1);
  }

  $('.tag-link').click(function() {
    var target = urlToRef(this.href);
    var node = document.getElementById(target);
    if(node.style.display !== 'block') {
      node.style.display = 'block';
    } else {
      node.style.display = 'none';
    }
    return false;
  });

  (function ($) {
    // custom css expression for a case-insensitive contains()
    jQuery.expr[':'].Contains = function(a,i,m){
      return (a.textContent || a.innerText || "").toUpperCase().indexOf(m[3].toUpperCase())>=0;
    };

    function listFilter() {
      $('.filterinput')
      .change( function () {
        var filter = $(this).val();
        if(filter) {
          // this finds all links in a list that contain the input,
          // and hide the ones not containing the input while showing the ones that do
          var hiddenList = $('.list-of-tags').find("a:not(:Contains(" + filter + "))");
          var visibleList = $('.list-of-tags').find("a:Contains(" + filter + ")");

          hiddenList.parent().hide();
          visibleList.parent().show();

          $.each(hiddenList, function(idx, el) {
            var target = urlToRef(el.href);
            document.getElementById(target).style.display = 'none';
          })
          $.each(visibleList, function(idx, el) {
            var target = urlToRef(el.href);
            document.getElementById(target).style.display = 'block';
          })


        } else {
          $('.list-of-tags').find("li").show();
          $('.tag-article-list-section').hide();
        }
        return false;
      })
      .keyup( function () {
        // fire the above change event after every letter
        $(this).change();
      });
    }

    //ondomready
    $(function () {
      listFilter($());
    });
  }(jQuery));
});
</script>
{% endblock %}
